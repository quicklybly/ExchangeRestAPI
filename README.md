# ExchangeRestAPI

[Тестовое задание](https://docs.google.com/document/d/1RqxScvHta4O-dcLy6YokrDEzT8x7XoP5/edit)

Автор: [Лысенко Артем](https://t.me/quicklybly)

## Содержание

* [Важно](#важно)
* [Стек технологий](#стек)
* [Запуск приложения](#запуск)
* [Дополнительные задания](#дополнительные-задания)
* [Демонстрация работы](#демонстрация)

## Важно

В ходе разработки было принято решение внедрить авторизацию пользователей через JWT токены,
это позволяет избежать передачи секретного ключа (пароля) в каждом запросе,
что упрощает жизнь как пользователя, так и разработчика.

Также было принято решение об изменении семантики некоторых запросов, например ответ
на запрос о курсе валют был изменен с

```
{
	"BTC": "0.00009564",
	"RUB": "180"
}
```

на

```
[
    {
        "currency": "BTC",
        "rate": "0.00009564",
    },
    {
        "currency": "RUB",
        "rate": "180",
    }
]
```

Это было сделано по двум причинам

1) Упростить парсинг запроса как фронтенду, так и бекенду.
2) Возможность расширять обьект, с передаваемой информацией (например добавить доступный для обмена лимит)

Все инструкции и изменения описаны в README, а также swagger документации.

## Стек

* Java 19
* Spring Boot 3.0.2
* Spring Security JWT auth
* Docker + Docker-compose
* PostgreSQL 15.2
* Swagger + OpenAPI v3
* JPA + Hibernate
* Postman

## Запуск

1) Установить зависимости maven

```
mvn clean install dependency:copy-dependencies
```

2) Поднять docker-compose

```
docker-compose pull
docker-compose up --build -d
```

## Дополнительные задания

* Подключена база данных PostgreSQL
* Реализовано подтверждение регистрации по почте
* Добавлено JWT аутенфикация при помощи Spring Security
* Добавлено разделение ролей с помощью Spring Security
* Сервер может отвечать на запросы в двух форматах JSON и XML.
  Для этого можно установить header accept:application/json или accept:application/xml
  В случае отсутствия header'a ответ будет в формате JSON
* Подключена документация Swagger
Для доступа к Swagger нужно перейти по [ссылке](http://localhost:8000/api/swagger-ui/index.html)
* Настроен Docker-compose Приложение + база данных.

## Демонстрация

### Регистрация

```
http://localhost:8000/api/auth/sign-up
```

Пример входящего запроса.

```
{
    "username": "username",
    "email": "email@mail.com"
}
```

Приложение проверяет, что пользователь еще не зарегистрирован и отправляет
ему на почту письмо с подтверждению.

### Активация учетной записи

```
http://localhost:8000/api/auth/activation?id={hashed_id}
```

После регистрации пользователь переходит по ссылке в письме и получает свой
пароль при успешной активации.
Пример сообщение об успешной активации:

Account activated.
Password: PucJV9NXZ9fkDHQQr56nb

Приложение также проверяет, что зашиврованный в ссылке id не был изменен,
и пользователь не был уже активирован.

### Логин

```
http://localhost:8000/api/auth/login
```

Позволяет пользователю войти в аккаунт.

Пример входящего запроса.

```
{
  "username": "username",
  "secret_key": "password"
}
```

В ответ пользователь получает JWT токен.
Пример.

```
{
    "token": "token-value"
}
```

### Важно

1) Все дальнейшие endpoint'ы будут доступны только при использовании JWT токена
   для авторизации.

2) Я использую Bearer токен. Для его установки нужно к запросу добавить header
   "Authorization" и ввести полученный в login токен в качесте значения header'a.
3) Так как я разрабатываю упрощенный вариант криптобиржи - системы, которая работает
   с деньгами пользователей, я использовал BigDecimal для хранения данных в приложении
   и Numeric(10, 10) для хранения в базе данных, при необходимости можно повысить точность
   хранимых данных.
4) Исходя из технического задания я сделал вывод, что админ не должен иметь
   доступа к endpointa'м пользователя (например просмотр кошелька), я не согласен
   с таким подходом, но сделал как в техническом задании. Это можно поправить
   буквально одной строкой в конфигурации Security.

### Просмотр баланса кошелька

```
http://localhost:8000/api/user/balance
```

Get запрос без тела.

Возвращает баланс кошелька текущего пользователя.
Пример ответа.

```
[
    {
        "wallet": "BTC_wallet",
        "amount": "2.13",
    },
    {
        "wallet": "RUB_wallet",
        "rate": "180",
    }
]
```

### Пополнение кошелька

```
http://localhost:8000/api/user/deposit
```

Post запрос. Запрос может упасть с ошибкой 404, если валюта, которую
передал пользователь не поддерживается биржей.
Входной запрос. Приписка _wallet и большие буквы не обязательны.

```
{
    "wallet": "TON_wallet",
    "amount": "1"
}
```

Ответ на запрос.

```
{
    "wallet": "TON_wallet",
    "amount": "new amount"
}
```

### Вывод денег с биржи

```
http://localhost:8000/api/user/withdraw
```

Post запрос. Запрос может упасть с ошибкой 404, если валюта, которую
передал пользователь не поддерживается биржей, или передано отрицательное
значение count или валюта и метод вывода не совпадают (у каждой валюты есть
тип CRYPTO или FIAT).

Входной запрос.

```
{
    "currency": "TON",
    "count": "1",
    "wallet": "AsS5A2SASd2as3q5sd2asd53a1s5"
}
```

Ответ на запрос.

```
{
    "wallet": "TON_wallet",
    "amount": "new amount"
}
```

### Обмен валюты

```
http://localhost:8000/api/user/exchange
```

Post запрос. Запрос может упасть с ошибкой 404, если валюта, которую
передал пользователь не поддерживается биржей, или передано отрицательное
значение amount или валютная пара не поддерживается.

Входной запрос.

```
{
    "currency_from": "USDT",
    "currency_to": "TON",
    "amount": "1"
}
```

Ответ на запрос.

```
{
    "currency_from": "RUB",
    "currency_to": "TON",
    "amount_from": "2000",
    "amount_to": "11.11"
}
```

### Просмотр актуальных курсов валют.

```
http://localhost:8000/api/user/exchange-rates
```

Get запрос. Доступен пользователю и админу. Запрос может упасть с ошибкой 404, если валюта, которую
передал пользователь не поддерживается биржей.

Входной запрос.

```
{
    "currency": "USDT"
}
```

Ответ на запрос.

```
[
    {
        "currency": "BTC",
        "rate": "0.00009564",
    },
    {
        "currency": "RUB",
        "rate": "180",
    }
]
```

### Запросы админа.

Для удобства проверки в систему уже занесен один админ.

Данные для входа.

```
{
    "username": "admin",
    "secret_key": "2lN5gjSPwX9evuMTYp2Rt"
}
```

### Изменение курса валют

```
http://localhost:8000/api/admin/change-rate
```

POST запрос.

Входной запрос.

```
{
    "base_currency": "usdt",
    "target_currencies": [
        {
            "currency": "ton",
            "rate": "2"
        },
        {
            "currency": "btc",
            "rate": "0.000031231"
        }
    ]
}
```

Возвращает список успешных обменов и список обменов, где была введена
неподдеживаемая валюта.

Ответ на запрос.

```
{
    "updated_rate": [
        {
            "currency": "ton",
            "rate": "2"
        },
        {
            "currency": "btc",
            "rate": "0.000031231"
        }
    ],
    "unsupported_currencies": []
}
```

### Посмотреть общую сумму на всех пользовательских счетах для указанной валюты.

```
http://localhost:8000/api/admin/total-amount
```

GET запрос.

Входной запрос.

```
{
    "currency": "ton"
}
```

Ответ на запрос.

```
{
    "wallet": "TON",
    "amount": "Total amount"
}
```

### Посмотреть количество операций, которые были проведены за указанный период.

```
http://localhost:8000/api/admin/operation-count
```

GET запрос. Дата принимается только в формате dd.MM.yyyy

Операции поделены на классы, что позволяет в будущем легко расширить собираемую
статистику, например узнать число оперций пополнение или вывода.

Входной запрос.

```
{
    "date_from": "27.02.2023",
    "date_to": "01.03.2023"
}
```

Ответ на запрос.

```
{
    "count": "123"
}
```













